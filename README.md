# Отчет по Тестированию EGO TGBot.

## ` Дмитрий Климов `

## 1. Тестирование корректности работы функций и Баг Репорт.

### 1.1. Баг Репорт (Фактические Сбои EGO TGBot)

| ID | Область | Описание бага | Шаги для воспроизведения (Фактические) | Ожидаемый результат | Фактический результат |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TG-S-001** | **Обработка команд** | Бот публикует служебные команды (/start, /help) в канал как посты. | 1. Отправить команду `/start` в привязанный чат. | Команда должна быть обработана TGBot и немедленно завершить выполнение без публикации в канале. | Команда `/start` опубликована в канале как новый пост. |
| **TG-S-002** | **AI-Интеграция** | EGO TGBot полностью игнорирует входящие комментарии, не инициируя AI-обработку. | 1. Оставить комментарий под постом (напр., "Когда будет следующий пост?"). | Ответ AI должен быть сгенерирован и отправлен в Billing UI (`pending_responses`). | Комментарий остается без реакции. |
| **TG-S-003** | **Провал фильтрации** | Бот публикует в канал некорректные/случайные сообщения (не команды) как посты. | Отправить в чат `/tgdskll` или любой другой текст. | Текст должен быть передан AI для генерации ответа или Spark-модулю для проверки спама, но не публиковаться как пост в канале. | Текст `/tgdskll` опубликован в канале. |


### 1.2. Прогноз системных уязвимостей.

| ID | Область | Описание уязвимости | Критически затронутые модули | Последствия |
| :--- | :--- | :--- | :--- | :--- |
| **TG-A-007** | **Транзакции Баланса/DB** | Отсутствие явной транзакционной защиты при списании баланса и записи комментария. | `database.py`, `Billing System` | Баланс может быть списан, даже если ответ не был доставлен пользователю из-за сбоя Proxy. |
| **TG-A-008** | **Кэширование Истории** | Механизм `generate_history_key` вероятно основан на временном кэше. | `utils.py`, `openai_api.py` | Потеря контекста при длительном диалоге (по истечении TTL кэша), что приводит к неадекватным AI-ответам. |
| **TG-A-009** | **Proxy Manager/OpenAI** | Проблема с логикой ротации прокси после сбоя. | `Proxy Manager`, `openai_api.py` | Если текущий прокси дал сбой, система может использовать Retries с этим же прокси, прежде чем переключиться на следующий (`set_next_proxy`), увеличивая задержку ответа. |
| **TG-A-010** | **WebSocket Асинхронность** | Блокировка основного потока TGBot при недоступности WebSocket-сервера. | `websocket.py`, `handle_message` | Если вебсокет-сервер недоступен, бот перестанет отвечать на все новые сообщения до восстановления соединения. |

## 2. Тестирование поведения бота в разных пользовательских сценариях.

### 2.1. Чек-лист поведения пользователей в Telegram.

| ID | Сценарий (Действие пользователя) | Цель проверки | Модули EGO | Критичность |
| :--- | :--- | :--- | :--- | :--- |
| **SC-T-01** | **Базовая коммуникация (Коммент)** | Проверка сквозного канала: Комментарий -> AI -> Pending. | `poll_comments`, `get_chatgpt_answer` | Высокая |
| **SC-T-03** | **Спам-текст (Коммент)** | Проверка работы модуля `Spam`. | `check_message_for_spam_http`, `decrement_spam_balance` | Высокая |
| **SC-T-05** | **Контекстная беседа (в чате)** | Проверка работы `generate_history_key`. | `get_chatgpt_answer` | Средняя |
| **SC-T-06** | **Команда /start** | Проверка фильтрации служебных команд. | `handle_message` | Критическая (Факт: Сбой) |
| **SC-T-10** | **Низкий баланс** | Реакция системы на `check_balance() < cost`. | `check_balance()`, `decrement_balance()` | Высокая |
| **SC-T-11** | **Медиа-контент** | Отправка сообщения с изображением (для проверки Spam). | `is_image_spam_http` | Средняя |

### 2.2. Репорт по пользовательским сценариям (EGO TGBot)

| ID | Сценарий | Проверка функций | Статус (Факт) | Комментарий |
| :--- | :--- | :--- | :--- | :--- |
| **SC-T-01** | *Коммент: "Когда будет следующий пост?"* | AI-обработка | **Провал** | Комментарий полностью проигнорирован (TG-S-002). |
| **SC-T-06** | *Команда: `/start`* | Исключение команд | **Критический Провал** | Команда опубликована в канале, что является утечкой служебной информации. |
| **SC-T-05** | *Контекст:* Сообщение в чат. | Логика `handle_message` | **Провал** | Бот воспринимает сообщения из чата как контент для постинга в канал, логика диалога не инициирована. |
| **SC-T-10** | *Низкий баланс* | `check_balance()` | **Невозможно проверить** | Невозможно изолировать причину молчания: либо баланс, либо сбой интеграции. Система должна логировать причину остановки. |

## 3. Предложение улучшений в работе бота.

### 3.1. Исправление Архитектурных Фундаментов (Критический Приоритет)

1.  **Исправление потока TGBot/Channel Integration (TG-S-001, TG-S-002):**
    *   **Приоритет Telegram Events:** TGBot должен четко различать, что является **комментарием** (и должно идти на AI) и что является **постом**. Проверить конфигурацию `Telegram Bot API` для супергруппы, чтобы избежать репоста сообщений в канал.
    *   **Немедленный Return для команд:** В `handle_message` реализовать безусловный `return` сразу после проверки на `/` (команды).

2.  **Защита Транзакций (TG-A-007):**
    *   **Транзакционный Коммит:** Гарантировать, что списание баланса (`deduct_balance_for_comment`) и фактическая отправка ответа в Telegram, происходят в рамках единой ACID-транзакции. Если отправка провалилась (Proxy error), баланс **не должен** списываться.

### 3.2. Повышение Надежности Системы (Высокий Приоритет)

3.  **Автоматическое Оповещение об отказе (SC-T-10):**
    *   Внедрить в `Proxy Manager` и `Database` (`check_balance`) механизм прямой отправки **критического уведомления** администратору (через Telegram API) в случае:
        *   Баланс опустился ниже порогового значения ($50).
        *   Три последовательных запроса через прокси провалились.

4.  **Обработка Асинхронности (TG-A-010):**
    *   Обеспечить, что вызовы к внешним сервисам (OpenAI, WebSocket) являются неблокирующими (`await`). TGBot должен логировать ошибку и **продолжать обработку** следующих входящих сообщений.

5.  **Оптимизация Proxy Retries (TG-A-009):**
    *   Модифицировать логику `sync_api_request_with_retry` для быстрой смены прокси: после первого сбоя текущего прокси, система должна немедленно переключаться на следующий прокси (`set_next_proxy`) и только затем повторять запрос.

### 3.3. Улучшение AI-Контекста

6.  **Контекстуальная Память (TG-A-008):**
    *   Оптимизировать механизм `generate_history_key`, используя гибридную модель: история диалога должна сохраняться в базе данных (MySQL) и привязываться к `user_id` и `post_id`.
    *   При обработке комментария к посту, всегда включать в промпт AI текст этого поста (используя `get_post_text`) для повышения релевантности ответа.

























# Отчет по Тестированию Модуля VK (ВКонтакте)

## ` Дмитрий Климов `

## 1. Тестирование корректности работы всех функций модуля ВК

### Основные функции VK Bot, подлежащие проверке

| Функция | Модуль | Ожидаемый результат | Критичность |
| :--- | :--- | :--- | :--- |
| **Callback Endpoint** | VK Bot | Успешный прием и подтверждение VK Callback события (HTTP 200 OK) в течение 1–2 секунд. | Критическая |
| **`check_balance()`** | Database | Проверка наличия средств перед вызовом AI. | Высокая |
| **`check_message_for_spam_http`** | Spam | Корректное определение спама/неспама, списание баланса за проверку. | Высокая |
| **`get_chatgpt_answer`** | OpenAI | Генерация релевантного ответа на комментарий (с учетом контекста поста). | Средняя |
| **`record_message_to_db`** | Database | Запись комментария и ответа в `pending_responses` (для модерации). | Высокая |
| **`sendWebSocket`** | WebSocket | Отправка уведомления в Billing UI о новом комментарии. | Средняя |
| **`send_comment_via_platform`** | VK Bot/Helpers | Фактическая отправка ответа в виде комментария-ответа в VK после одобрения модератором. | Критическая |
| **`vk_autonomous`** | Settings | При включении автономного режима ответ отправляется мгновенно, минуя Pending. | Высокая |

### Баг Репорт (Прогнозируемые ошибки VK Bot)

| ID | Область | Описание бага | Шаги для воспроизведения (Прогноз) | Влияние на систему |
| :--- | :--- | :--- | :--- | :--- |
| **VK-B-001** | **Callback API** | Сбой подтверждения VK Callback API из-за медленного ответа сервера. | Отправить комментарий с очень длинным текстом (вызывающим долгую обработку AI) в автономном режиме. | VK может счесть Callback нерабочим (таймаут > 5-10 сек), что приведет к отключению интеграции. |
| **VK-B-002** | **Контекст/Посты** | Смешивание контекста диалогов между разными постами. | 1. Пользователь 1 оставляет коммент под Постом A. 2. Пользователь 1 оставляет коммент под Постом B. | Бот отвечает на Пост B, используя историю диалога из Поста A (если `post_id` отсутствует в ключе истории). |
| **VK-B-003** | **Транзакции/Баланс** | Списание баланса за недоставленный ответ. | 1. Одобрить ответ в Billing UI. 2. Во время отправки ответа через `send_comment_via_platform` VK API возвращает ошибку (напр., комментарий удален пользователем). | Баланс списывается, хотя ответ не был доставлен. |
| **VK-B-004** | **Прямые сообщения (DM)** | AI-логика не различает DM и комментарий к посту. | Пользователь ведет DM-диалог с ботом, затем оставляет комментарий. | История DM используется для ответа на публичный комментарий (или наоборот). |
| **VK-B-005** | **Spam/Медиа** | Бот не обрабатывает изображения/видео, присланные в комментарии, на предмет спама. | Пользователь присылает комментарий, состоящий только из изображения или видео. | Медиа не передается в `is_image_spam_http` (модуль Spam), спам остается неочищенным. |

## 2. Тестирование поведения бота в разных пользовательских сценариях

### Чек-лист поведения пользователей в VK

| ID | Сценарий (Действие пользователя) | Цель проверки | Ожидаемое поведение VK Bot | Критичность |
| :--- | :--- | :--- | :--- | :--- |
| **VK-SC-01** | **Новый комментарий (Позитив)** | Проверка сквозного канала и тональности. | Бот генерирует позитивный/нейтральный ответ, отправляет в Pending, WebSocker уведомляет модератора. | Высокая |
| **VK-SC-02** | **Новый комментарий (Негатив)** | Проверка настройки `vk_approve_negative`. | Бот генерирует сочувствующий ответ, обязательно попадает в Pending. | Высокая |
| **VK-SC-03** | **Комментарий с внешней ссылкой** | Проверка `check_message_for_spam_http` и блокировки. | Если ссылка не спам (SC-T-03), обрабатывает. Если спам, игнорирует и списывает баланс за проверку. | Высокая |
| **VK-SC-04** | **Автономный режим (ON)** | Проверка мгновенного ответа и списания баланса. | Бот отвечает в течение 5-10 секунд, минуя Pending. Баланс списывается немедленно. | Средняя |
| **VK-SC-05** | **Ответ в личные сообщения (DM)** | Проверка обработки DM и контекста. | Бот отвечает в личных сообщениях. `generate_history_key` использует только `user_id`. | Средняя |
| **VK-SC-06** | **Ответ на старый пост (1 месяц)** | Проверка актуальности информации и `extract_deadline`. | AI должен учесть, что пост старый, и не упоминать сроки, если они были в посте. | Средняя |
| **VK-SC-07** | **Редактирование комментария** | Проверка реакции бота на редактирование уже отправленного комментария. | Бот должен игнорировать отредактированное сообщение, чтобы избежать повторной AI-обработки. | Низкая |

### Репорт по пользовательским сценариям (Прогноз)

| ID | Сценарий | Проверка функций | Статус (Прогноз) | Комментарий |
| :--- | :--- | :--- | :--- | :--- |
| **VK-SC-01** | *Коммент: "Мне очень понравилась ваша акция!"* | `get_chatgpt_answer` | **Успех** | Ответ сгенерирован, попал в Pending. После одобрения ответ отправлен в VK. |
| **VK-SC-02** | *Коммент: "Я недоволен ценами."* | `vk_approve_negative` | **Успех** | Тональность определена как негативная (1-5). Ответ сгенерирован, отправлен в Pending, помечен для ручной модерации. |
| **VK-SC-04** | *Автономный режим ON.* | Сквозной канал | **Частичный сбой** | Ответ отправлен мгновенно. *Прогноз сбоя:* В случае высокой нагрузки может произойти таймаут VK Callback (VK-B-001). |
| **VK-SC-05** | *DM: "Здравствуйте, какая цена?"* | DM-обработка | **Частичный сбой** | Бот отвечает. *Прогноз сбоя:* Диалог в DM может не попадать в Billing UI, если логика `vk_callback2` обрабатывает только события `comment_new` и `post_new`, но не `message_new`. |

## 3. Предложение улучшений в работе бота с VK

### Улучшение 1: Асинхронное подтверждение VK Callback

**Проблема:** Медленная обработка AI/DB может привести к таймауту VK Callback (VK-B-001) и отключению интеграции.

**Предложение:** Модуль `vk_callback2` должен немедленно возвращать HTTP 200 OK, как только сообщение получено. Вся тяжелая логика (`check_balance`, `check_spam`, `get_chatgpt_answer`) должна быть перенесена в отдельный асинхронный поток (`asyncio` или `Celery/Redis`), инициированный после подтверждения 200 OK.

### Улучшение 2: Четкое разделение контекста Диалогов и Комментариев (VK-B-002, VK-B-004)

**Проблема:** Риск смешивания контекстов между постами и DM.

**Предложение:** Обеспечить, чтобы `generate_history_key` в `utils.py` строго различал типы диалогов:

*   **Комментарий к посту:** `key = hash(platform_id + user_id + post_id)`
*   **DM (Личное сообщение):** `key = hash(platform_id + user_id + "DM_ID")` (или уникальный ID чата DM).

### Улучшение 3: Компенсация Баланса при ошибках VK API (VK-B-003)

**Проблема:** Списание баланса происходит, даже если VK API не смог отправить ответ пользователю.

**Предложение:** Использовать принцип компенсации (SAGA pattern).

1.  **Проверка:** `deduct_balance_for_comment()` вызывается перед отправкой.
2.  **Компенсация:** Если `send_comment_via_platform` возвращает ошибку VK API (например, из-за удаленного комментария или невалидного токена), система должна **немедленно инициировать компенсацию** (`revert_balance()`) и логировать ошибку списания.





























