# Отчет по Тестированию EGO TGBot.

## ` Дмитрий Климов `

## 1. Тестирование корректности работы функций и Баг Репорт.

### 1.1. Баг Репорт (Фактические Сбои EGO TGBot)

| ID | Область | Описание бага | Шаги для воспроизведения (Фактические) | Ожидаемый результат | Фактический результат |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TG-S-001** | **Обработка команд** | Бот публикует служебные команды (/start, /help) в канал как посты. | 1. Отправить команду `/start` в привязанный чат. | Команда должна быть обработана TGBot и немедленно завершить выполнение без публикации в канале. | Команда `/start` опубликована в канале как новый пост. |
| **TG-S-002** | **AI-Интеграция** | EGO TGBot полностью игнорирует входящие комментарии, не инициируя AI-обработку. | 1. Оставить комментарий под постом (напр., "Когда будет следующий пост?"). | Ответ AI должен быть сгенерирован и отправлен в Billing UI (`pending_responses`). | Комментарий остается без реакции. |
| **TG-S-003** | **Провал фильтрации** | Бот публикует в канал некорректные/случайные сообщения (не команды) как посты. | Отправить в чат `/tgdskll` или любой другой текст. | Текст должен быть передан AI для генерации ответа или Spark-модулю для проверки спама, но не публиковаться как пост в канале. | Текст `/tgdskll` опубликован в канале. |


### 1.2. Прогноз системных уязвимостей.

| ID | Область | Описание уязвимости | Критически затронутые модули | Последствия |
| :--- | :--- | :--- | :--- | :--- |
| **TG-A-007** | **Транзакции Баланса/DB** | Отсутствие явной транзакционной защиты при списании баланса и записи комментария. | `database.py`, `Billing System` | Баланс может быть списан, даже если ответ не был доставлен пользователю из-за сбоя Proxy. |
| **TG-A-008** | **Кэширование Истории** | Механизм `generate_history_key` вероятно основан на временном кэше. | `utils.py`, `openai_api.py` | Потеря контекста при длительном диалоге (по истечении TTL кэша), что приводит к неадекватным AI-ответам. |
| **TG-A-009** | **Proxy Manager/OpenAI** | Проблема с логикой ротации прокси после сбоя. | `Proxy Manager`, `openai_api.py` | Если текущий прокси дал сбой, система может использовать Retries с этим же прокси, прежде чем переключиться на следующий (`set_next_proxy`), увеличивая задержку ответа. |
| **TG-A-010** | **WebSocket Асинхронность** | Блокировка основного потока TGBot при недоступности WebSocket-сервера. | `websocket.py`, `handle_message` | Если вебсокет-сервер недоступен, бот перестанет отвечать на все новые сообщения до восстановления соединения. |

## 2. Тестирование поведения бота в разных пользовательских сценариях.

### 2.1. Чек-лист поведения пользователей в Telegram.

| ID | Сценарий (Действие пользователя) | Цель проверки | Модули EGO | Критичность |
| :--- | :--- | :--- | :--- | :--- |
| **SC-T-01** | **Базовая коммуникация (Коммент)** | Проверка сквозного канала: Комментарий -> AI -> Pending. | `poll_comments`, `get_chatgpt_answer` | Высокая |
| **SC-T-03** | **Спам-текст (Коммент)** | Проверка работы модуля `Spam`. | `check_message_for_spam_http`, `decrement_spam_balance` | Высокая |
| **SC-T-05** | **Контекстная беседа (в чате)** | Проверка работы `generate_history_key`. | `get_chatgpt_answer` | Средняя |
| **SC-T-06** | **Команда /start** | Проверка фильтрации служебных команд. | `handle_message` | Критическая (Факт: Сбой) |
| **SC-T-10** | **Низкий баланс** | Реакция системы на `check_balance() < cost`. | `check_balance()`, `decrement_balance()` | Высокая |
| **SC-T-11** | **Медиа-контент** | Отправка сообщения с изображением (для проверки Spam). | `is_image_spam_http` | Средняя |

### 2.2. Репорт по пользовательским сценариям (EGO TGBot)

| ID | Сценарий | Проверка функций | Статус (Факт) | Комментарий |
| :--- | :--- | :--- | :--- | :--- |
| **SC-T-01** | *Коммент: "Когда будет следующий пост?"* | AI-обработка | **Провал** | Комментарий полностью проигнорирован (TG-S-002). |
| **SC-T-06** | *Команда: `/start`* | Исключение команд | **Критический Провал** | Команда опубликована в канале, что является утечкой служебной информации. |
| **SC-T-05** | *Контекст:* Сообщение в чат. | Логика `handle_message` | **Провал** | Бот воспринимает сообщения из чата как контент для постинга в канал, логика диалога не инициирована. |
| **SC-T-10** | *Низкий баланс* | `check_balance()` | **Невозможно проверить** | Невозможно изолировать причину молчания: либо баланс, либо сбой интеграции. Система должна логировать причину остановки. |

## 3. Предложение улучшений в работе бота с данной сетью

### 3.1. Исправление Архитектурных Фундаментов (Критический Приоритет)

1.  **Исправление потока TGBot/Channel Integration (TG-S-001, TG-S-002):**
    *   **Приоритет Telegram Events:** TGBot должен четко различать, что является **комментарием** (и должно идти на AI) и что является **постом**. Проверить конфигурацию `Telegram Bot API` для супергруппы, чтобы избежать репоста сообщений в канал.
    *   **Немедленный Return для команд:** В `handle_message` реализовать безусловный `return` сразу после проверки на `/` (команды).

2.  **Защита Транзакций (TG-A-007):**
    *   **Транзакционный Коммит:** Гарантировать, что списание баланса (`deduct_balance_for_comment`) и фактическая отправка ответа в Telegram, происходят в рамках единой ACID-транзакции. Если отправка провалилась (Proxy error), баланс **не должен** списываться.

### 3.2. Повышение Надежности Системы (Высокий Приоритет)

3.  **Автоматическое Оповещение об отказе (SC-T-10):**
    *   Внедрить в `Proxy Manager` и `Database` (`check_balance`) механизм прямой отправки **критического уведомления** администратору (через Telegram API) в случае:
        *   Баланс опустился ниже порогового значения ($50).
        *   Три последовательных запроса через прокси провалились.

4.  **Обработка Асинхронности (TG-A-010):**
    *   Обеспечить, что вызовы к внешним сервисам (OpenAI, WebSocket) являются неблокирующими (`await`). TGBot должен логировать ошибку и **продолжать обработку** следующих входящих сообщений.

5.  **Оптимизация Proxy Retries (TG-A-009):**
    *   Модифицировать логику `sync_api_request_with_retry` для быстрой смены прокси: после первого сбоя текущего прокси, система должна немедленно переключаться на следующий прокси (`set_next_proxy`) и только затем повторять запрос.

### 3.3. Улучшение AI-Контекста

6.  **Контекстуальная Память (TG-A-008):**
    *   Оптимизировать механизм `generate_history_key`, используя гибридную модель: история диалога должна сохраняться в базе данных (MySQL) и привязываться к `user_id` и `post_id`.
    *   При обработке комментария к посту, всегда включать в промпт AI текст этого поста (используя `get_post_text`) для повышения релевантности ответа.


