# 1. Тестирование корректности работы всех функций бота

### Область тестирования
Канал: `https://t.me/testego181`

### Основные функции TGBot, подлежащие проверке (по документации README_tgbot.md)

| Функция | Модуль | Ожидаемый результат в супергруппе/комментариях |
| :--- | :--- | :--- |
| **`handle_message`** | TGBot | Успешная обработка входящего сообщения. |
| **`check_balance()`** | Database | Проверка наличия средств перед обработкой AI. |
| **`check_message_for_spam_http`** | Spam | Корректное определение спама/неспама и списание баланса за проверку. |
| **`get_chatgpt_answer`** | OpenAI | Генерация адекватного ответа с учетом истории диалога. |
| **`record_message_to_db`** | Database | Запись сообщения и ответа в `pending_responses`. |
| **`sendWebSocket`** | WebSocket | Отправка уведомления в Billing UI о необходимости модерации. |
| **Отправка ответа** | TGBot/Proxy | Фактическая отправка ответа пользователю после одобрения модератором. |
| **`decrement_balance`** | Database | Корректное списание средств за отправленный ответ. |

### Баг Репорт (Теоретические/Прогнозируемые ошибки)

| ID | Область | Описание бага | Шаги для воспроизведения (Теоретические) | Ожидаемый результат | Фактический результат (Прогноз) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TG-B-001** | **Баланс** | Сбой процесса модерации при низком балансе. | 1. Установить баланс < 10 (2х стоимость ответа). 2. Отправить сообщение, вызывающее AI. 3. Одобрить ответ через Billing UI. | Ответ отправлен, баланс списан, или ответ не отправлен, если списание невозможно, и модератору показано предупреждение. | Одобрение проходит, но ответ не отправляется из-за сбоя `decrement_balance()` в середине транзакции. Статус в БД остается как "согласован", но Telegram-пользователь ответ не получает. |
| **TG-B-002** | **Контекст** | Потеря контекста при длительном диалоге в супергруппе. | 1. Пользователь 1 задает вопрос в супергруппе. 2. Бот отвечает. 3. Пользователь 1 задает связанный вопрос через 30+ минут (после возможного истечения TTL кэша истории). | Бот продолжает разговор, используя историю, сгенерированную по `generate_history_key(user_id, post_id)`. | Бот игнорирует предыдущее сообщение и отвечает как на первый вопрос (потеря кэша истории). |
| **TG-B-003** | **Spam Check** | Некорректное списание баланса при проверке спама. | 1. Отправить сообщение, которое система классифицирует как спам. 2. Проверить историю баланса (`balance_history`). | Баланс списывается только за проверку спама (`decrement_spam_balance()`), ответ не генерируется и не списывается. | Если проверка спама возвращает ошибку, но `decrement_spam_balance()` уже сработал, баланс списан необоснованно. |
| **TG-B-004** | **Proxy/Retry** | Ответ отправляется в Telegram с большой задержкой после одобрения. | 1. Инициировать отказ текущего прокси в `Proxy Manager`. 2. Одобрить ответ в Billing UI. | Ответ отправляется после успешного переключения на следующий прокси (`set_next_proxy`) и retries, с фиксацией длительного времени ответа. | Из-за таймаута при попытке отправки бот не переключает прокси вовремя, и отправка ответа прерывается, статус отправки остается неопределенным. |
| **TG-B-005** | **Интеграция** | Отсутствие WebSocket уведомления при появлении новой записи. | 1. Отправить сообщение в супергруппу. 2. Проверить Billing UI. | Счетчик pending responses обновляется в реальном времени, запись появляется сразу. | Запись появляется в БД, но `send_to_websocket` не срабатывает из-за ошибки соединения/конфигурации, и модератор не получает уведомление. |

# 2. Тестирование поведения бота в разных пользовательских сценариях

### Чек-лист поведения пользователей в Telegram

| ID | Сценарий (Действие пользователя) | Цель проверки | Ожидаемое поведение TGBot | Критичность |
| :--- | :--- | :--- | :--- | :--- |
| **SC-T-01** | **Базовая коммуникация** | Проверка сквозного канала: TGBot -> AI -> Pending -> Billing -> TGBot. | Генерирует ответ, отправляет на модерацию (pending), после одобрения отправляет ответ в чат. | Высокая |
| **SC-T-02** | **Негативный отзыв** | Проверка тональности и адекватности ответа. | AI генерирует сочувствующий, вежливый ответ, ответ попадает в pending (если `tg_approve_negative` включен). | Высокая |
| **SC-T-03** | **Спам-текст** | Проверка работы модуля `Spam` и логики отклонения. | `check_message_for_spam_http` возвращает True. Сообщение удаляется/игнорируется. Баланс списывается только за проверку. | Высокая |
| **SC-T-04** | **Спам-изображение** | Проверка работы с медиаконтентом. | `is_image_spam_http` возвращает True. Сообщение удаляется/игнорируется. Баланс списывается только за проверку. | Средняя |
| **SC-T-05** | **Контекстная беседа** | Проверка работы `generate_history_key` и `get_chatgpt_answer` с историей. | Бот помнит предыдущий вопрос/ответ и дает связанный ответ. | Средняя |
| **SC-T-06** | **Команда /start** | Проверка обработки встроенных команд. | Бот игнорирует команду или дает стандартный приветственный ответ (не должен попадать в Pending). | Низкая |
| **SC-T-07** | **Срок/Deadline** | Проверка работы `extract_deadline` (если используется в промпте). | AI генерирует ответ, учитывающий крайний срок (например, "ответим завтра до 14:00"). | Низкая |
| **SC-T-08** | **Автономный режим** | Проверка работы без модерации (если `tg_autonomous` = True). | Бот отвечает мгновенно (менее 10 секунд). Баланс списывается сразу. Ответ не попадает в pending. | Высокая |
| **SC-T-09** | **Отредактированное сообщение** | Проверка реакции бота на редактирование уже отправленного сообщения. | TGBot должен игнорировать редактирование, или повторно обработать, если это критично. (Зависит от конфигурации Telegram API, но в идеале должен игнорировать). | Средняя |

### Репорт по пользовательским сценариям (Теоретические результаты)

| ID | Сценарий | Проверка функций | Статус (Прогноз) | Комментарий |
| :--- | :--- | :--- | :--- | :--- |
| **SC-T-01** | *Сообщение: "Когда будет следующий пост?"* | `handle_message`, `get_chatgpt_answer` | **Успех** | Сообщение обработано, сгенерирован ответ "Скоро!". Запись появилась в Billing UI, после одобрения ответ отправлен в чат. |
| **SC-T-02** | *Сообщение: "Ваш сервис ужасен, я ухожу."* | Тональность (негатив), `tg_approve_negative` | **Успех** | TGBot определил негатив (1-5). Ответ сгенерирован, но помещен в Pending. Модератор отредактировал ответ. |
| **SC-T-03** | *Спам-текст (ссылка + капслок)* | `check_message_for_spam_http` | **Частичный сбой** | Текст классифицирован как спам, сообщение удалено. Баланс успешно списан за проверку. *Прогноз сбоя:* В логах отсутствует информация о списании баланса за спам. |
| **SC-T-05** | *User1: "Какая у вас стоимость?" -> User1: "А скидки есть?"* | `generate_history_key` | **Успех** | Первый ответ содержал цену. Второй ответ использовал контекст ("Да, если вы покупаете 5 услуг, действует скидка..."). |
| **SC-T-08** | *Включение автономного режима.* | `tg_autonomous` | **Успех** | После сохранения настроек (`/update_settings`), новое сообщение получает немедленный ответ. В Billing UI запись не появляется. |
| **SC-T-09** | *Редактирование сообщения.* | API Update Event | **Сбой** | При редактировании бот не реагирует, но логирует событие. В БД сохраняется только исходный текст, что может привести к неточностям в аналитике. |

# 3. Предложение улучшений в работе бота с данной сетью

### Улучшение 1: Внедрение многоуровневой логики модерации (Tiered Approval)

**Проблема:** Даже позитивные или очевидно нейтральные комментарии попадают в очередь на модерацию (`pending_responses`), что замедляет реакцию системы.

**Предложение:** Использовать гибкую логику `tg_approve_...` в `update_settings` для автоматизации на основе **тональности и уверенности AI**.

1.  **Уровень 1: Полная Автономия (High Confidence Positive/Neutral).** Если тональность **позитивная (9-10)** или **нейтральная (6-8)**, и **Confidence Score > 90%** (если AI API предоставляет такой скор), ответ отправляется немедленно, минуя Pending.
2.  **Уровень 2: Быстрая Модерация (Moderate Confidence Negative/Any).** Если тональность **негативная (1-5)** или **Confidence Score 70-90%**, ответ попадает в Pending, но помечен красным флагом "Срочно" в Billing UI, а WebSocket уведомление должно иметь повышенный приоритет.
3.  **Уровень 3: Ручная Обработка (Low Confidence/Image Spam).** Если Spam-модуль не смог однозначно определить спам или Confidence Score < 70%, сообщение помещается в Pending с флагом "Требует ручного просмотра" (не только одобрения, но и генерации ответа).

**Преимущества:** Значительное снижение нагрузки на модератора и ускорение реакции на 60–80% входящих сообщений.

### Улучшение 2: Система активного мониторинга Proxy и Баланса через TGBot

**Проблема:** Критические сбои (закончился баланс или отказали все прокси) выявляются модератором только при попытке взаимодействия или через просмотр логов (`/ego18/billing/logs`).

**Предложение:** Внедрить механизм критических оповещений TGBot -> Администратору.

1.  **Alerting Hook:** Реализовать в модулях `Proxy Manager` и `Database` (функции `check_balance` / `decrement_balance`) дополнительный хук, который при достижении критического порога (например, Баланс < 100 руб., или 3+ Proxy Failures за 5 минут) отправляет прямое сообщение/уведомление администратору через Telegram API.
2.  **`Emergency Stop` API:** Добавить в TGBot маршрут для активации/деактивации режима "Остановки" (аналогично `emergency_stop.js` на фронте), который блокирует любые списания и AI-запросы до пополнения баланса.

**Преимущества:** Минимизация потерь из-за несвоевременного пополнения баланса и снижение стоимости мониторинга прокси.

### Улучшение 3: Оптимизация обработки сообщений из канала и супергруппы

**Проблема:** TGBot должен различать сообщения, отправленные в привязанный чат (`t.me/testego18`), и комментарии, связанные с конкретным постом в канале (`t.me/testego181`). В документации не очевидно, как происходит связывание `post_id` для комментариев.

**Предложение:** Уточнить логику `post_id` в `record_message_to_db`.

1.  **Комментарии в канале:** Если сообщение является комментарием к посту (Telegram API предоставляет `reply_to_message.message_id` или подобный контекст), то `post_id` должен быть уникальным идентификатором поста в канале. Это критично для корректного использования `post_text` в генерации ответов и для аналитики.
2.  **Прямые сообщения в супергруппе:** Если сообщение не является ответом на пост, `post_id` должен быть пустым или иметь заглушку (например, `chat_{chat_id}`) для корректной работы `generate_history_key` (которая использует `post_id` для контекста).

**Преимущества:** Улучшенная точность AI-ответов за счет использования контекста поста, а также корректное агрегирование данных в аналитике (`/api/analytics/social/posts`).
